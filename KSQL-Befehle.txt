CREATE STREAM FLUEGE_BY_KKN AS
SELECT
  *
FROM FLUEGE
PARTITION BY KKN;

CREATE TABLE FLUEGE_BY_KKN_LSK_S AS
SELECT
    	KKN 		      AS KKN_KEY,
	LATEST_BY_OFFSET(FLA) AS FLA_AGG,
	LATEST_BY_OFFSET(KNR) AS KNR_AGG,
	LATEST_BY_OFFSET(LSK) AS LSK_AGG,
	LATEST_BY_OFFSET(SAA) AS SAA_AGG,
	LATEST_BY_OFFSET(STT) AS STT_AGG
FROM FLUEGE_BY_KKN
WHERE LSK = 'S'
GROUP BY KKN
EMIT CHANGES;

CREATE TABLE FLUEGE_BY_KKN_LSK_L AS
SELECT
    	KKN 		      AS KKN_KEY,
	LATEST_BY_OFFSET(FLA) AS FLA_AGG,
	LATEST_BY_OFFSET(KNR) AS KNR_AGG,
	LATEST_BY_OFFSET(LSK) AS LSK_AGG,
	LATEST_BY_OFFSET(SAA) AS SAA_AGG,
	LATEST_BY_OFFSET(STT) AS STT_AGG
FROM FLUEGE_BY_KKN
WHERE LSK = 'L'
GROUP BY KKN
EMIT CHANGES;

CREATE TABLE JOIN_KKN_L_S AS
	SELECT
		L.KKN_KEY         AS KKN_L,
		L.FLA_AGG         AS FLA_L,
		L.KNR_AGG         AS KNR_L,
		L.LSK_AGG         AS LSK_L,
		L.SAA_AGG         AS SAA_L,
		L.STT_AGG         AS STT_L,
		S.KKN_KEY         AS KKN_S,
		S.FLA_AGG         AS FLA_S,
		S.KNR_AGG         AS KNR_S,
		S.LSK_AGG         AS LSK_S,
		S.SAA_AGG         AS SAA_S,
		S.STT_AGG         AS STT_S
	FROM FLUEGE_BY_KKN_LSK_L L
	JOIN FLUEGE_BY_KKN_LSK_S S
	ON L.KKN_KEY = S.KKN_KEY
EMIT CHANGES;
